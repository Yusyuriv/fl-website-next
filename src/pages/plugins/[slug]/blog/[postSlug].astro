---
import Layout from "@/layouts/Layout.astro";
import {GET} from "@/pages/plugins.json";
import {ExtendedPlugin} from "@/pages/plugins/_types";
import {getCollection, getEntry, render} from "astro:content";
import SectionSubheader from "@/components/SectionSubheader.astro";
import SectionHeader from "@/components/SectionHeader.astro";
import Section from "@/components/Section.astro";
import {formatDate} from "@/utils";
import path from "node:path";

interface Props {
  plugin: ExtendedPlugin;
  post: any;
}

export async function getStaticPaths() {
  const pluginsManifest = await GET().then(v => v.json()) as ExtendedPlugin[];
  const plugins = await getCollection("plugins");
  console.log(plugins[0]);
  const data = await getCollection("pluginBlog");
  return data.map((v: any) => {
    const plugin = plugins.find(p => {
      const pluginPath = path.resolve(p.filePath, "..", "blog");
      const postPath = path.resolve(v.filePath, "..");

      return pluginPath === postPath;
    });
    const pluginManifest = pluginsManifest.find(p => p.slug === plugin.data.slug);
    return {
      params: {
        slug: plugin.data.slug,
        postSlug: v.data.slug,
      },
      props: {
        plugin: pluginManifest,
        post: v,
      },
    };
  });
}

const {plugin, post} = Astro.props;
const {Content} = await render(post);
---
<Layout>
  <Section>
    <div class="header">
      <img src={plugin.icon} alt="" class="plugin-icon"/>

      <div class="title">
        <SectionHeader>{plugin.name} Plugin Blog</SectionHeader>
        <SectionSubheader>{post.data.title}</SectionSubheader>
        <div class="author-date">
          <span class="muted">by</span>
          {post.data.author}
          <span class="muted">on</span>
          <time datetime={post.data.date}>{formatDate(post.data.date)}</time>
        </div>
      </div>
    </div>
  </Section>
  <Section even padding="18" class="blog-content">
    <Content />
  </Section>
</Layout>

<style>
.header {
    display: flex;
    align-items: center;
    gap: 12px;
}

.plugin-icon {
    width: 64px;
    height: 64px;
    object-fit: contain;
}

.title {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.author-date {
    font-size: 14px;
}

.muted {
    opacity: 0.5;
}

.blog-content {
    flex-grow: 1;
}
</style>

<script>
import 'fslightbox';
import {addLightboxToBlogPostImages} from "@/utils";

addLightboxToBlogPostImages();
</script>
